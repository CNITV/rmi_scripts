#!/usr/bin/env python3
#
# Adds participations into CMS
#
# Made by Tudor Roman, public domain
#
# This script expects as its first argument a table generated by add_users.
# The second argument is the id of the contest.
#

import csv
import sys
import binascii
import os
from subprocess import call
from collections import namedtuple

if len(sys.argv) != 4:
    print("Usage: add_participations <csv_file> <contest_id> <out_file>")
    sys.exit(1)

contest_id = sys.argv[2]
User = namedtuple('User', 'first_name last_name username password team_name team_id')
users = []

with open(sys.argv[1]) as file:
    reader = csv.DictReader(file, delimiter=',')
    for row in reader:
        password = 'p' + binascii.b2a_hex(os.urandom(6)).decode('ascii')
        first_name = row['first_name'].strip()
        last_name = row['last_name'].strip()
        team_id = row['team_id'].strip()
        team_name = row['team_name'].strip()
        username = row['username'].strip()
        call(['cmsAddParticipation', '-c', contest_id, '-t', team_id, '-p', password, username])
        users.append(User(first_name, last_name, username, password, team_name, team_id))

with open(sys.argv[3], 'w') as out_file:
    writer = csv.writer(out_file)
    writer.writerow(['first_name', 'last_name', 'username', 'password', 'team_name', 'team_id'])
    for u in users:
        writer.writerow(u)
